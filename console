#! /usr/bin/env python

# axiom admin console

import os
import getpass
import fire
import toml

from tools import gen_auth
from db_query import AxiomDB

default_db = 'axiom.db'

def confirm_request(question):
    prompt = '[y/N]'
    response = input(f'{question} [y/N]: ').lower()
    return response == 'y'

class Config:
    def auth(self, path, overwrite=False):
        if overwrite or not os.path.exists(path) or confirm_request(f'overwrite {path}?'):
            with open(path, 'w+') as fid:
                auth = gen_auth()
                toml.dump(auth, fid)

class User:
    def list(self, db=default_db):
        adb = AxiomDB(path=db)
        for u in adb.get_all_users():
            print(u)

    def create(self, email, name=None, password=None, confirm=True, db=default_db):
        if name is None:
            name, _ = email.split('@')
        if password is None:
            password = getpass.getpass()
        adb = AxiomDB(path=db)
        adb.add_user(email, name, password, confirm=confirm)

    def delete(self, email, db=default_db):
        if confirm_request('delete user?'):
            adb = AxiomDB(path=db)
            if adb.del_user(email):
                print(f'{email} deleted')
            else:
                print(f'{email} not found')

class Index:
    def regen(self, db=default_db):
        adb = AxiomDB(path=db)
        adb.reindex_articles()

    def title(self, query, db=default_db):
        adb = AxiomDB(path=db)
        arts = adb.search_title(query)
        for a in arts:
            print(a)

    def paras(self, query, db=default_db):
        adb = AxiomDB(path=db)
        paras = adb.search_text(query)
        for p in paras:
            print(p)

class Main:
    def __init__(self):
        self.config = Config()
        self.user = User()
        self.index = Index()

if __name__ == '__main__':
    fire.Fire(Main)
